<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–û–Ω–ª–∞–π–Ω-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background:#f5f6fa; margin:0; padding:0; }
    .chat-container {
      max-width: 500px; margin:40px auto; background:#fff; border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.1); display:flex; flex-direction:column; height:600px; overflow:hidden;
    }
    .chat-header { background:#0a3d62; color:#fff; padding:15px; text-align:center; font-weight:bold; }
    .chat-messages { flex:1; padding:15px; overflow-y:auto; display:flex; flex-direction:column; gap:10px; background:#f9f9fb; }
    .message { max-width:80%; padding:10px 14px; border-radius:12px; font-size:14px; line-height:1.4; }
    .bot { background:#eef4f9; align-self:flex-start; }
    .user { background:#ff6b6b; color:#fff; align-self:flex-end; }
    .chat-input { display:flex; border-top:1px solid #ddd; }
    .chat-input input { flex:1; padding:12px; border:none; outline:none; font-size:14px; }
    .chat-input button { padding:0 15px; border:none; background:#ff6b6b; color:#fff; font-weight:bold; cursor:pointer; display:flex; align-items:center; }
    .chat-input button:hover { background:#ff4b4b; }
    .chat-input button svg { width:18px; height:18px; fill:#fff; }
    audio { margin-top:5px; }
    #leadOverlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:9998; }
    #leadPopup, #leadThanks {
      display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      background:#fff; padding:20px; border-radius:12px; z-index:9999; width:90%; max-width:350px;
      box-shadow:0 0 20px rgba(0,0,0,0.3); text-align:center;
    }
    #leadPopup h3 { margin-bottom:10px; }
    #leadPopup input { width:100%; padding:10px; margin:8px 0; border:1px solid #ccc; border-radius:8px; }
    #leadPopup button { width:100%; padding:12px; border:none; background:#ff6b6b; color:#fff; font-weight:bold; border-radius:8px; cursor:pointer; }
    #leadPopup button:hover { background:#ff4b4b; }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">–û–Ω–ª–∞–π–Ω-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç</div>
    <div class="chat-messages" id="chat"></div>
    <div class="chat-input">
      <button onclick="sendPhoto()">üì∑</button>
      <input type="text" id="chatInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
      <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <button onclick="startVoice()" title="–ì–æ–≤–æ—Ä–∏—Ç—å">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512">
          <path d="M192 256c0 17.7-14.3 32-32 32s-32-14.3-32-32V128c0-17.7 14.3-32 32-32s32 14.3 32 32V256zM160 320c35.3 0 64-28.7 64-64V128a64 64 0 1 0-128 0V256c0 35.3 28.7 64 64 64zm56 32H104c-13.3 0-24 10.7-24 24s10.7 24 24 24h24v56c0 13.3 10.7 24 24 24s24-10.7 24-24V400h24c13.3 0 24-10.7 24-24s-10.7-24-24-24z"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Overlay + —Ñ–æ—Ä–º–∞ -->
  <div id="leadOverlay"></div>
  <div id="leadPopup">
    <h3>–û—Å—Ç–∞–≤—å—Ç–µ –∑–∞—è–≤–∫—É</h3>
    <input id="leadName" placeholder="–í–∞—à–µ –∏–º—è">
    <input id="leadPhone" placeholder="+7 (___) ___-__-__">
    <button onclick="submitLead()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>
  <div id="leadThanks">‚úÖ –°–ø–∞—Å–∏–±–æ, —Å–∫–æ—Ä–æ —Å–≤—è–∂–µ–º—Å—è</div>

  <script>
    const OPENAI_PROXY_URL = "https://openai-gpt-proxy-mcnj.onrender.com/gpt";
    const LEAD_URL = "https://openai-gpt-proxy-mcnj.onrender.com/lead";
    const ELEVEN_URL = "https://elevenlabs-proxy-1o1s.onrender.com/stream";
    
    const chatBox = document.getElementById("chat");
    const chatInput = document.getElementById("chatInput");
    let messages = [];
    let userId = localStorage.getItem("userId") || "user_" + Math.random().toString(36).substr(2,9);
    localStorage.setItem("userId", userId);
    let photoUploaded = false;

    function appendMessage(text, fromUser=false){
      const div = document.createElement("div");
      div.className = "message " + (fromUser ? "user" : "bot");
      div.textContent = text;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function sendMessage(){
      const text = chatInput.value.trim();
      if(!text) return;
      appendMessage(text,true);
      messages.push({role:"user", content:text});
      chatInput.value="";

      // –≤–µ—Ç–∫–∞ 3: —Å—Ä–∞–∑—É –ø—Ä–æ —Ü–µ–Ω—É –±–µ–∑ —Ñ–æ—Ç–æ
      if(messages.length === 1 && /—Å–∫–æ–ª—å–∫–æ/i.test(text) && !photoUploaded){
        appendMessage("–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –Ω–∞–¥–µ—é—Å—å –í—ã –Ω–µ –ø—Ä–æ—Ç–∏–≤ –∞—É–¥–∏–æ—Ñ–æ—Ä–º–∞—Ç–∞... –° —Ä–∞–¥–æ—Å—Ç—å—é —Å–æ—Ä–∏–µ–Ω—Ç–∏—Ä—É—é –ø–æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏, –Ω–æ –Ω—É–∂–Ω–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å –º–∞—Å—à—Ç–∞–± —Ä–∞–±–æ—Ç—ã. –ö–æ–≥–æ –±—ã –≤—ã —Ö–æ—Ç–µ–ª–∏ –∏–∑–æ–±—Ä–∞–∑–∏—Ç—å –Ω–∞ –ø–æ—Ä—Ç—Ä–µ—Ç–µ?", false);
        return;
      }

      try {
        const res = await fetch(OPENAI_PROXY_URL,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ messages, userId, mode:"portraits" })
        });
        const data = await res.json();
        let reply = data.choices?.[0]?.message?.content || "–û—à–∏–±–∫–∞";
        
        if(/\[openLeadForm\]/i.test(reply) || data.triggerForm){
          reply = reply.replace(/\[openLeadForm\]/gi,"").trim();
          openLeadForm();
        }

        appendMessage(reply,false);
        messages.push({role:"assistant", content:reply});

        if(data.voice?.text){
          playVoice(data.voice.text);
        }

      } catch(e){
        appendMessage("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è",false);
      }
    }

    function sendPhoto(){
      photoUploaded = true;
      appendMessage("üì∑ –§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ", true);
      messages.push({role:"user", content:"[photo]"});
      appendMessage("–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –Ω–∞–¥–µ—é—Å—å –í—ã –Ω–µ –ø—Ä–æ—Ç–∏–≤ –∞—É–¥–∏–æ—Ñ–æ—Ä–º–∞—Ç–∞... –î–ª—è –≤–∞—à–µ–π —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –æ—Ç–ª–∏—á–Ω–æ –ø–æ–¥–æ–π–¥–µ—Ç —Å—Ç–∏–ª—å —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –∂–∏–≤–æ–ø–∏—Å—å. –°–µ–π—á–∞—Å –ø—Ä–∏—à–ª—é –ø—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç.", false);
    }

    async function playVoice(text){
      try {
        const ttsRes = await fetch(ELEVEN_URL,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ text })
        });
        const blob = await ttsRes.blob();
        const audioUrl = URL.createObjectURL(blob);

        const div = document.createElement("div");
        div.className = "message bot";
        div.innerHTML = `<audio controls src="${audioUrl}"></audio>`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;

        new Audio(audioUrl).play();
      } catch(err){ console.error("TTS error", err); }
    }

    function openLeadForm(){
      document.getElementById("leadOverlay").style.display="block";
      document.getElementById("leadPopup").style.display="block";
    }
    function closeForms(){
      document.getElementById("leadOverlay").style.display="none";
      document.getElementById("leadPopup").style.display="none";
      document.getElementById("leadThanks").style.display="none";
    }
    document.getElementById("leadOverlay").onclick=closeForms;

    async function submitLead(){
      const name = document.getElementById("leadName").value.trim();
      const phone = document.getElementById("leadPhone").value.trim();
      if(!name || phone.length<6) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ");

      document.getElementById("leadPopup").style.display="none";
      document.getElementById("leadThanks").style.display="block";
      setTimeout(closeForms,2500);

      await fetch(LEAD_URL,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ name, phone, userId, messages })
      });
    }

    function startVoice(){
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = "ru-RU";
      recognition.start();
      recognition.onresult = (e)=>{
        const text = e.results[0][0].transcript;
        chatInput.value=text;
        sendMessage();
      };
      recognition.onerror=()=>alert("–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è");
    }

   // –∞–≤—Ç–æ-–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ ‚Ññ2 (–±–µ–∑ —Ñ–æ—Ç–æ) ‚Äî –≥–æ–ª–æ—Å–æ–º
window.onload=()=>{
  setTimeout(()=>{
    playVoice("–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –Ω–∞–¥–µ—é—Å—å –í—ã –Ω–µ –ø—Ä–æ—Ç–∏–≤ –∞—É–¥–∏–æ—Ñ–æ—Ä–º–∞—Ç–∞. –ú–µ–Ω—è –∑–æ–≤—É—Ç –ê–Ω–Ω–∞, —è —Å—Ç–∞—Ä—à–∏–π –º–µ–Ω–µ–¥–∂–µ—Ä. –î–ª—è —Ä–∞—Å—á–µ—Ç–∞ –ø–æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –Ω—É–∂–Ω–∞ –≤–∞—à–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è, —á—Ç–æ–±—ã –ø–æ–¥–æ–±—Ä–∞—Ç—å —Å—Ç–∏–ª—å. –ü—Ä–∏—à–ª–∏—Ç–µ —Ñ–æ—Ç–æ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞.");
  },800);
}
